# é€šç”¨ OpenAI æ ¼å¼åä»£æ³¨å…¥æœåŠ¡ (è‡ªå®šä¹‰æç¤ºè¯ã€åŠ¨æ€å˜é‡ä¸æ­£åˆ™å¤„ç†)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªä½¿ç”¨ FastAPI æ„å»ºçš„é€šç”¨ OpenAI æ ¼å¼åä»£æ³¨å…¥æœåŠ¡ã€‚å®ƒæ¥æ”¶æ ‡å‡†çš„ OpenAI Chat Completion API æ ¼å¼è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚ä»£ç†è½¬å‘åˆ°ä»»æ„çš„ OpenAI å…¼å®¹ API ç«¯ç‚¹ï¼ŒåŒæ—¶æ”¯æŒå¼ºå¤§çš„æç¤ºè¯æ¨¡æ¿æ³¨å…¥ã€åŠ¨æ€å˜é‡å¤„ç†å’Œå“åº”åå¤„ç†åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ“¡ é€šç”¨åä»£æ³¨å…¥
- **åŠ¨æ€ç›®æ ‡æå–**: ä»è¯·æ±‚ URL ä¸­æå–ç›®æ ‡ OpenAI å…¼å®¹ API ç«¯ç‚¹
- **URL æ ¼å¼**: `/{http(s)://target.domain.com}/v1/chat/completions`
- **å¤šç§è®¤è¯æ–¹å¼**: æ”¯æŒ Authorization å¤´æˆ– URL æŸ¥è¯¢å‚æ•°ä¼ é€’ API å¯†é’¥
- **å‚æ•°ç®¡ç†**: å¿½ç•¥å®¢æˆ·ç«¯å‚æ•°ï¼Œå¼ºåˆ¶ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤ç”Ÿæˆå‚æ•°

### ğŸ¯ æç¤ºè¯æ¨¡æ¿æ³¨å…¥
- **æ™ºèƒ½æ¨¡æ¿é€‰æ‹©**: æ ¹æ®ç”¨æˆ·è¾“å…¥å†…å®¹è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ¨¡æ¿ï¼ˆæœ‰è¾“å…¥/æ— è¾“å…¥ï¼‰
- **å†å²æ¶ˆæ¯æ³¨å…¥**: æ”¯æŒé€šè¿‡ `api_input_placeholder` åœ¨æ¨¡æ¿ä¸­æ³¨å…¥å†å²å¯¹è¯
- **å˜é‡æ›¿æ¢**: æ¨¡æ¿ä¸­çš„ `{{user_input}}` ä¼šè¢«æ›¿æ¢ä¸ºç”¨æˆ·çš„å®é™…è¾“å…¥
- **æ¶ˆæ¯åˆå¹¶**: è‡ªåŠ¨åˆå¹¶ç›¸é‚»çš„åŒè§’è‰²æ¶ˆæ¯ï¼Œä¼˜åŒ–å¯¹è¯ç»“æ„

### ğŸ² åŠ¨æ€å˜é‡ç³»ç»Ÿ
- **éª°å­æŠ•æ·**: `{{roll XdY}}` - æ¨¡æ‹ŸæŠ•æ· X ä¸ª Y é¢éª°å­å¹¶æ›¿æ¢ä¸ºæ€»ç‚¹æ•°ã€‚
- **éšæœºé€‰æ‹©**: `{{random::é€‰é¡¹1::é€‰é¡¹2::é€‰é¡¹3}}` - ä»æä¾›çš„é€‰é¡¹ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªã€‚
- **å˜é‡è®¾ç½®**: `{{setvar::å˜é‡å::å€¼}}` - è®¾ç½®ä¸€ä¸ªå˜é‡ï¼Œç”¨äºåœ¨å¯¹è¯ä¸­ä¼ é€’å’Œå­˜å‚¨çŠ¶æ€ã€‚
- **å˜é‡è·å–**: `{{getvar::å˜é‡å}}` - è·å–å·²è®¾ç½®çš„å˜é‡å€¼ã€‚
- **å®æ—¶å¤„ç†**: æ¯æ¬¡è¯·æ±‚æ—¶åŠ¨æ€è®¡ç®—ï¼Œç¡®ä¿ç»“æœçš„éšæœºæ€§å’ŒçŠ¶æ€çš„å®æ—¶æ€§ã€‚

### ğŸ”§ å“åº”åå¤„ç†
- **æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™**: å¯¹ API å“åº”å†…å®¹åº”ç”¨è‡ªå®šä¹‰çš„æŸ¥æ‰¾æ›¿æ¢è§„åˆ™ã€‚
- **JSON è½½è·æ³¨å…¥**: æ”¯æŒå‘å“åº”ä¸­æ³¨å…¥ç»“æ„åŒ– JSON æ•°æ®ã€‚
- **è§„åˆ™çº§è”**: æŒ‰å®šä¹‰é¡ºåºä¾æ¬¡åº”ç”¨å¤šä¸ªæ­£åˆ™è§„åˆ™ã€‚

### ğŸŒŠ æµå¼ä¸éæµå¼æ”¯æŒ
- **çœŸå®æµå¼**: ç›´æ¥ä»£ç†ç›®æ ‡ API çš„æµå¼å“åº”ã€‚
- **éæµå¼**: å¤„ç†æ™®é€šçš„å®Œæ•´å“åº”ã€‚
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„è¶…æ—¶å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚

## ğŸš€ éƒ¨ç½² (Deployment)

æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨ Docker (æ¨è) æˆ–æ‰‹åŠ¨è¿›è¡Œéƒ¨ç½²ã€‚

### ä½¿ç”¨ Docker (æ¨è)

è¿™æ˜¯æœ€ç®€å•ã€æœ€æ¨èçš„éƒ¨ç½²æ–¹å¼ï¼Œå®ƒå°†åº”ç”¨åŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ‰“åŒ…åˆ°ä¸€ä¸ªéš”ç¦»çš„å®¹å™¨ä¸­ã€‚

1.  **å®‰è£… Docker**: ç¡®ä¿æ‚¨çš„ç³»ç»Ÿå·²ç»å®‰è£…äº† Docker å’Œ Docker Composeã€‚

2.  **é…ç½®æœåŠ¡**:
    -   å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š
        ```bash
        cp config/settings.yaml.example config/settings.yaml
        ```
    -   æ ¹æ®éœ€è¦ç¼–è¾‘ `config/settings.yaml` å’Œ `templates/` ç›®å½•ä¸‹çš„æ¨¡æ¿æ–‡ä»¶ã€‚

3.  **å¯åŠ¨æœåŠ¡**: åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    docker compose up --build -d
    ```
    æœåŠ¡å°†åœ¨ `http://localhost:8001` ä¸Šè¿è¡Œã€‚

    > **çƒ­æ›´æ–°è¯´æ˜**: `docker-compose.yml` æ–‡ä»¶é»˜è®¤é…ç½®äº†ç›®å½•æŒ‚è½½ã€‚è¿™æ„å‘³ç€æ‚¨åœ¨æœ¬åœ°ä¿®æ”¹ `config` å’Œ `templates` ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶ï¼Œå®¹å™¨å†…çš„åº”ç”¨ä¼š**è‡ªåŠ¨çƒ­é‡è½½**ï¼Œæ— éœ€é‡å¯å®¹å™¨ã€‚åŒæ—¶ï¼Œ`src` ç›®å½•ä¹Ÿè¢«æŒ‚è½½ï¼Œå¹¶å¼€å¯äº† `--reload` æ¨¡å¼ï¼Œæ–¹ä¾¿å¼€å‘æ—¶ä¿®æ”¹ä»£ç åæœåŠ¡è‡ªåŠ¨é‡å¯ã€‚

### æ‰‹åŠ¨å®‰è£…éƒ¨ç½²

1.  **å®‰è£…ä¾èµ–**:
    ```bash
    pip install -r requirements.txt
    ```

2.  **é…ç½®æœåŠ¡**:
    -   å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š
        ```bash
        cp config/settings.yaml.example config/settings.yaml
        ```
    -   ç¼–è¾‘ `config/settings.yaml` é…ç½®æ–‡ä»¶ï¼Œè°ƒæ•´å„é¡¹å‚æ•°ã€‚
    -   å‡†å¤‡æç¤ºè¯æ¨¡æ¿æ–‡ä»¶ï¼š
        - `templates/with_input.yaml` - ç”¨æˆ·æœ‰è¾“å…¥æ—¶çš„æ¨¡æ¿
        - `templates/without_input.yaml` - ç”¨æˆ·æ— è¾“å…¥æ—¶çš„æ¨¡æ¿

3.  **å¯åŠ¨æœåŠ¡**:
    ```bash
    # é»˜è®¤ç«¯å£ä¸º 8001
    uvicorn src.main:app --host 0.0.0.0 --port 8001
    ```

## ğŸ“– API ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬è¯·æ±‚æ ¼å¼
```
POST /{target_url}/v1/chat/completions
```

### URL ç¤ºä¾‹
æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `8001` ç«¯å£ã€‚

```bash
# ä»£ç†åˆ° OpenAI å®˜æ–¹ API
curl -X POST "http://localhost:8001/https://api.openai.com/v1/chat/completions" \
-H "Authorization: Bearer your-openai-api-key" \
-H "Content-Type: application/json" \
-d '{
  "model": "gpt-4",
  "messages": [{"role": "user", "content": "Hello!"}],
  "stream": false
}'

# ä»£ç†åˆ°å…¶ä»–å…¼å®¹æœåŠ¡ (ä¾‹å¦‚ Anthropic)
curl -X POST "http://localhost:8001/https://api.anthropic.com/v1/chat/completions" \
-H "x-api-key: your-anthropic-api-key" \
-H "Content-Type: application/json" \
-d '{
  "model": "claude-3-5-sonnet-20240620",
  "messages": [{"role": "user", "content": "Hello!"}]
}'

# ä½¿ç”¨ URL å‚æ•°ä¼ é€’ API å¯†é’¥
curl -X POST "http://localhost:8001/https://api.openai.com/v1/chat/completions?api_key=your-api-key" \
-H "Content-Type: application/json" \
-d '{
  "model": "gpt-4",
  "messages": [{"role": "user", "content": "Hello!"}]
}'
```

### æ”¯æŒçš„å®¢æˆ·ç«¯å‚æ•°
æœåŠ¡åªæ¥å—ä»¥ä¸‹å®¢æˆ·ç«¯å‚æ•°ï¼Œå…¶ä»–å‚æ•°ä¼šè¢«å¿½ç•¥å¹¶ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼ï¼š
- `model`
- `messages`
- `stream`

## ğŸ“ é¡¹ç›®ç»“æ„

```
hajimir/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py               # FastAPI åº”ç”¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ openai_client.py      # OpenAI å®¢æˆ·ç«¯é€»è¾‘
â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ template_handler.py   # æ¨¡æ¿å¤„ç†å™¨ (å«åŠ¨æ€å˜é‡)
â”‚   â”œâ”€â”€ conversion_utils.py   # å“åº”åå¤„ç†å·¥å…·
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.yaml.example # é…ç½®æ¨¡æ¿
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ with_input.yaml       # æœ‰ç”¨æˆ·è¾“å…¥æ—¶çš„æ¨¡æ¿
â”‚   â””â”€â”€ without_input.yaml    # æ— ç”¨æˆ·è¾“å…¥æ—¶çš„æ¨¡æ¿
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Dockerfile              # Docker é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml      # ç¼–æ’æ–‡ä»¶
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â””â”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
```

## âš™ï¸ é…ç½®è¯´æ˜

### ä¸»è¦é…ç½®é¡¹
`config/settings.yaml`
```yaml
app_name: "hajimir"
log_level: "INFO"
debug_mode: false

proxy:
  prompt_template_path_with_input: "templates/with_input.yaml"
  prompt_template_path_without_input: "templates/without_input.yaml"
  openai_request_timeout: 60

openai_generation:
  temperature: 1.0
  max_tokens: 4096
  top_p: 1.0
  frequency_penalty: 0.0
  presence_penalty: 0.0
```

### æ¨¡æ¿æ–‡ä»¶æ ¼å¼
æ¨¡æ¿æ–‡ä»¶ä½¿ç”¨ YAML æ ¼å¼ï¼Œæ”¯æŒä»¥ä¸‹ç±»å‹çš„é¡¹ï¼š
```yaml
# æ™®é€šæ¶ˆæ¯æ¨¡æ¿
- role: "system"
  content: "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚ç”¨æˆ·è¾“å…¥ï¼š{{user_input}}"

# å†å²æ¶ˆæ¯å ä½ç¬¦
- type: "api_input_placeholder"

# æ­£åˆ™å¤„ç†è§„åˆ™
- type: "æ­£åˆ™"
  æŸ¥æ‰¾: "\\[PLACEHOLDER\\]"
  æ›¿æ¢: "å®é™…å†…å®¹"
  action: "replace"

# JSON è½½è·æ³¨å…¥
- type: "æ­£åˆ™"
  æŸ¥æ‰¾: ".*"
  æ›¿æ¢: '{"code": "print(\"Hello World\")", "language": "python"}'
  action: "json_payload"
```

## ğŸ” é«˜çº§åŠŸèƒ½

### åŠ¨æ€å˜é‡
åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨åŠ¨æ€å˜é‡ï¼Œå®ç°æ›´å¤æ‚çš„é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†ã€‚

```yaml
# ç¤ºä¾‹ï¼šè®¾ç½®å¹¶ä½¿ç”¨å˜é‡
- role: "system"
  content: "è®°ä½ç”¨æˆ·åã€‚{{setvar::username::Alex}}"

- role: "user"
  content: "æˆ‘çš„åå­—æ˜¯ {{getvar::username}}ã€‚æŠ•æ·ä¸€ä¸ªå…­é¢éª°å­ï¼š{{roll 1d6}}ï¼Œéšæœºé€‰æ‹©ï¼š{{random::è‹¹æœ::é¦™è•‰::æ©™å­}}"
```
`{{setvar}}` æ ‡ç­¾ä¼šåœ¨å¤„ç†åè¢«ç§»é™¤ï¼Œè€Œ `{{getvar}}`, `{{roll}}`, `{{random}}` ä¼šè¢«æ›¿æ¢ä¸ºè®¡ç®—åçš„å€¼ã€‚

### æ­£åˆ™åå¤„ç†
å¯¹ API å“åº”è¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç†ï¼š
```yaml
- type: "æ­£åˆ™"
  æŸ¥æ‰¾: "\\b(é”™è¯¯|error)\\b"
  æ›¿æ¢: "ä¿®æ­£"
  action: "replace"
```

### JSON è½½è·æ³¨å…¥
å‘å“åº”ä¸­æ³¨å…¥ç»“æ„åŒ–æ•°æ®ï¼š
```yaml
# æ­¤ç¤ºä¾‹å°†ä»£ç å—æå–å¹¶æ³¨å…¥åˆ°æŒ‡å®šçš„ JSON ç»“æ„ä¸­
- type: "æ­£åˆ™"
  æŸ¥æ‰¾: "```python\\n(.+?)\\n```"
  æ›¿æ¢: '{"tool_code_interpreter_output": {"code": "$1", "language": "python"}}'
  action: "json_payload"
```

## ğŸ“ æ³¨æ„äº‹é¡¹
1.  **API å¯†é’¥å®‰å…¨**: ç¡®ä¿ API å¯†é’¥çš„å®‰å…¨ä¼ è¾“å’Œå­˜å‚¨ã€‚
2.  **è¶…æ—¶è®¾ç½®**: æ ¹æ®ç›®æ ‡ API çš„å“åº”æ—¶é—´è°ƒæ•´ `openai_request_timeout` é…ç½®ã€‚
3.  **æ¨¡æ¿æ›´æ–°**: æ¨¡æ¿æ–‡ä»¶æ”¯æŒçƒ­é‡è½½ï¼Œä¿®æ”¹åè‡ªåŠ¨ç”Ÿæ•ˆã€‚
4.  **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ—¥å¿—è®°å½•æœ‰åŠ©äºè°ƒè¯•å’Œç›‘æ§ï¼Œå¯é€šè¿‡ `log_level` æ§åˆ¶ã€‚
5.  **Docker éƒ¨ç½²**: ä½¿ç”¨ Docker éƒ¨ç½²æ—¶ï¼Œè¯·ç¡®ä¿ `docker-compose.yml` ä¸­æŒ‚è½½çš„æœ¬åœ°ç›®å½•è·¯å¾„æ­£ç¡®ã€‚

## ğŸ¤ è´¡çŒ®
æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›é¡¹ç›®ï¼

## ğŸ“„ è®¸å¯è¯
æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
